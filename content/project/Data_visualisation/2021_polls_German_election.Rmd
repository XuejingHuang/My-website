---
title: "Opinion Polls for 2021 German Election"
author: "LBS-MAM22 Group 5"
date: "`r Sys.Date()`"
tags: ["homework", "data visualisation"]
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
---

```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r load-libraries, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(lubridate)
library(fivethirtyeight)
library(here)
library(skimr)
library(janitor)
library(vroom)
library(tidyquant)
library(rvest) # to scrape wikipedia page
```

# Opinion polls for the 2021 German elections

The Guardian newspaper has an [election poll tracker for the upcoming German election](https://www.theguardian.com/world/2021/aug/20/german-election-poll-tracker-who-will-be-the-next-chancellor). The list of the opinion polls since Jan 2021 can be found at [Wikipedia](https://en.wikipedia.org/wiki/Opinion_polling_for_the_2021_German_federal_election) and your task is to reproduce the graph similar to the one produced by the Guardian.

The following code will scrape the wikipedia page and import the table in a dataframe.

```{r, scrape_wikipedia_polling_data, warnings= FALSE, message=FALSE}
url <- "https://en.wikipedia.org/wiki/Opinion_polling_for_the_2021_German_federal_election"
# https://www.economist.com/graphic-detail/who-will-succeed-angela-merkel
# https://www.theguardian.com/world/2021/jun/21/german-election-poll-tracker-who-will-be-the-next-chancellor


# get tables that exist on wikipedia page 
tables <- url %>% 
  read_html() %>% 
  html_nodes(css="table")


# parse HTML tables into a dataframe called polls 
# Use purr::map() to create a list of all tables in URL
polls <- map(tables, . %>% 
             html_table(fill=TRUE)%>% 
             janitor::clean_names())


# list of opinion polls
german_election_polls <- polls[[1]] %>% # the first table on the page contains the list of all opinions polls
  slice(2:(n()-1)) %>%  # drop the first row, as it contains again the variable names and last row that contains 2017 results
  mutate(
         # polls are shown to run from-to, e.g. 9-13 Aug 2021. We keep the last date, 13 Aug here, as the poll date
         # and we extract it by picking the last 11 characters from that field
         end_date = str_sub(fieldwork_date, -11),
         
         # end_date is still a string, so we convert it into a date object using lubridate::dmy()
         end_date = dmy(end_date),
         
         # we also get the month and week number from the date, if we want to do analysis by month- week, etc.
         month = month(end_date),
         week = isoweek(end_date)
         )


german_election_polls %>% 
  ggplot() +
  # union
  geom_point(aes(x=end_date,y=union, colour="UNION"),shape=21)+
  # span=0.2 to make the line less smoothed
  geom_smooth(aes(x=end_date,y=union, colour="UNION"),se=F,span = 0.2)+ 
  # spd
  geom_point(aes(x=end_date,y=spd, colour="SPD"),shape=21)+
  geom_smooth(aes(x=end_date,y=spd,colour="SPD"),se=F,span = 0.2)+
  # afd
  geom_point(aes(x=end_date,y=af_d,colour="AFD"),shape=21)+
  geom_smooth(aes(x=end_date,y=af_d,colour="AFD"),se=F,span = 0.2)+
  #fdp
  geom_point(aes(x=end_date,y=fdp,colour="FDP"),shape=21)+
  geom_smooth(aes(x=end_date,y=fdp,colour="FDP"),se=F,span = 0.2)+
  #grune
  geom_point(aes(x=end_date,y=grune, colour="GRUNE"),shape=21)+
  geom_smooth(aes(x=end_date,y=grune,colour="GRUNE"),se=F,span = 0.2)+
  #linke
  geom_point(aes(x=end_date,y=linke,colour="LINKE"),shape=21)+
  geom_smooth(aes(x=end_date,y=linke,colour="LINKE"),se=F,span = 0.2)+
  #display every month
  scale_x_date(date_labels="%b %y",date_breaks  ="1 month")+
  labs(
    x="Date",
    y="Votes %"
  )+
  scale_colour_manual("", 
                      breaks = c("UNION","SPD","AFD","FDP","GRUNE","LINKE"),
                      values = c("black","red","blue","yellow","dark green","purple"))+
  NULL

```



# Team members

- Alex Kubbinga
- Clara Moreno Sanchez
- Jean Huang
- Raghav Mehta
- Raina Doshi
- Yuan Gao